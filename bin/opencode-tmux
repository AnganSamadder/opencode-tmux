#!/usr/bin/env bash

OPENCODE_PORT_START="${OPENCODE_PORT:-4096}"
OPENCODE_PORT_MAX=$((OPENCODE_PORT_START + 10))

# Find the real opencode binary, ignoring this script
SCRIPT_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/$(basename "${BASH_SOURCE[0]}")"
OPENCODE_BIN=""

IFS=: read -ra PATHS <<< "$PATH"
for dir in "${PATHS[@]}"; do
    if [ -x "$dir/opencode" ] && [ "$dir/opencode" != "$SCRIPT_PATH" ]; then
        OPENCODE_BIN="$dir/opencode"
        break
    fi
done

if [ -z "$OPENCODE_BIN" ]; then
    # Fallback: try finding it with which, excluding this script
    OPENCODE_BIN="$(which -a opencode 2>/dev/null | grep -v "$SCRIPT_PATH" | head -1)"
fi

if [ -z "$OPENCODE_BIN" ]; then
    echo "Error: opencode command not found in PATH"
    exit 1
fi

check_port() {
    local port=$1
    if command -v lsof >/dev/null 2>&1; then
        lsof -i ":$port" -sTCP:LISTEN -t >/dev/null 2>&1
        return $?
    elif command -v nc >/dev/null 2>&1; then
        nc -z localhost "$port" >/dev/null 2>&1
        return $?
    else
        curl -s "http://localhost:$port/health" >/dev/null 2>&1
        return $?
    fi
}

find_available_port() {
    local port=$OPENCODE_PORT_START
    
    while [ $port -le $OPENCODE_PORT_MAX ]; do
        if ! check_port "$port"; then
            echo "$port"
            return 0
        fi
        port=$((port + 1))
    done
    
    echo "Error: All ports from $OPENCODE_PORT_START to $OPENCODE_PORT_MAX are in use"
    echo "Please stop an existing OpenCode instance or set OPENCODE_PORT to a different range"
    exit 1
}

AVAILABLE_PORT=$(find_available_port)

if [ -z "$AVAILABLE_PORT" ]; then
    exit 1
fi

if [ "$AVAILABLE_PORT" != "$OPENCODE_PORT_START" ]; then
    echo "⚠️  Port $OPENCODE_PORT_START is in use, using port $AVAILABLE_PORT instead"
fi

export OPENCODE_PORT="$AVAILABLE_PORT"

if [ -n "$TMUX" ]; then
    exec "$OPENCODE_BIN" --port "$AVAILABLE_PORT" "$@"
else
    exec tmux new-session "$OPENCODE_BIN --port $AVAILABLE_PORT $*"
fi
